<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.0.0/dist/tf.min.js"></script>
  </head>
  <body class="container">
    <h1>Juego Ta te ti</h1>
    <p>Vos jug√°s con las X</p>
    <div class="row gap-2">
      <div>
        <button id="0" class="btn btn-outline-primary">-</button>
        <button id="1" class="btn btn-outline-primary">-</button>
        <button id="2" class="btn btn-outline-primary">-</button>
      </div>
      <div>
        <button id="3" class="btn btn-outline-primary">-</button>
        <button id="4" class="btn btn-outline-primary">-</button>
        <button id="5" class="btn btn-outline-primary">-</button>
      </div>
      <div>
        <button id="6" class="btn btn-outline-primary">-</button>
        <button id="7" class="btn btn-outline-primary">-</button>
        <button id="8" class="btn btn-outline-primary">-</button>
      </div>
    </div>

    <script>
      // 1 == x
      // 0 == empty
      // -1 == o

      const jugada = [0, 0, 0, 0, 0, 0, 0, 0, 0];

      const buttons = document.querySelectorAll("button");

      buttons.forEach((button) => {
        button.addEventListener("click", (e) => {
          const button = e.target;
          jugada[button.id] = 1;
          button.textContent = "X";
          console.log(jugada);
          playOfModel();
        });
      });

      function playOfModel() {
        tf.ready().then(() => {
          const modelPath = "model/ttt_model.json";
          tf.tidy(() => {
            tf.loadLayersModel(modelPath).then((model) => {
              // Three board states
              const play = tf.tensor(jugada);

              // Stack states into a shape [3, 9]
              const matches = tf.stack([play]);
              const result = model.predict(matches);
              // Log the results
              result.print();

              const winMatch = winBoard(jugada);

              if (winMatch) {
                alert(winMatch === 1 ? "Ganaste" : "Perdiste");
                jugada.fill(0);
                buttons.forEach((button) => {
                  button.textContent = "-";
                  play.dispose();
                  matches.dispose();
                });
              } else {
                result.data().then((data) => {
                  const dataArr = Array.from(data);
                  const max = Math.max(...dataArr);
                  const index = dataArr.indexOf(max);
                  jugada[index] = -1;
                  buttons[index].textContent = "O";
                });
              }
            });
          });
        });
      }

      function winBoard(board) {
        const winStates = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];

        for (let i = 0; i < winStates.length; i++) {
          const [a, b, c] = winStates[i];
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return board[a];
          }
        }
        return null;
      }
    </script>
  </body>
</html>
